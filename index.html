<!doctype html>
<html lang="en">
  <head>
    <title>Semantic Libebreaker</title>
    <meta charset="utf-8">
    <style>
      html {
        height: 100%;
      }
      body {
        height: -webkit-calc(100% - 2em);
        height: calc(100% - 2em);
      }
      #textbox {
        height: -webkit-calc(100% - 5em);
        height: calc(100% - 5em);
        width: 90%;
        margin-bottom: 1.5em;
        clear: both;
        line-height: 1.3em;
      }
      form {
        text-align: center;
        width: 100%;
        height: -webkit-calc(100% - 4em);
        height: calc(100% - 4em);
      }
    </style>
    <script>
      function capturePaste() { 
        // http://stackoverflow.com/q/2176861/
        setTimeout(breakPhrases, 1);
      }
      function breakPhrases() {
        var textArea = document.getElementById("textbox");
        // http://stackoverflow.com/q/4698560/
        var scrollTop = textArea.scrollTop;
        // http://stackoverflow.com/q/3286595/
        var selStart = textArea.selectionStart;
        var selEnd = textArea.selectionEnd;
        var manualMode = document.getElementById("manual-mode");
        // clean up previous runs
        textArea.value = textArea.value.replace(/^(.{0,72})◀/gm, "$1");
        // don't do any parsing if we're editing in manual mode
        if( !manualMode.checked ) {
          // break on conjunctions
          textArea.value = textArea.value.replace(/(.{20,}?) (or|and|but|that|e(\. ?)?g\.?|i(\. ?)?e\.?) /g, "$1\n$2 ");
          // break on punctuation
          textArea.value = textArea.value.replace(/(.{20,}?)([,.?!][”"]?|[:;]) /g, "$1$2\n");
          // mark too long lines, if there are any left
          textArea.value = textArea.value.replace(/^([^◀\n]{72,}?)(?!◀) /gm, "$1◀ ");
        }
        textArea.scrollTop = scrollTop;
        textArea.selectionStart = selStart;
        textArea.selectionEnd = selEnd;
      }
    </script>
  </head>
  <body>
    <p>
      Paste your text below
      to have it automatically formatted
      using <a href="http://rhodesmill.org/brandon/2012/one-sentence-per-line/">
      semantic linebreaks</a>:
    </p>
    <form>
      <textarea id="textbox" onpaste='capturePaste();' onkeyup='breakPhrases();' autofocus></textarea>
      <br>
      <input type="reset" value="clear">
      <input id="manual-mode" type="checkbox" value="manual">
      <label for="manual-mode">Manual mode</label>  
    </form>
  </body>
</html>
